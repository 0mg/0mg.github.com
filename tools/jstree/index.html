<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>JavaScript Object Tree</title>
    <style type="text/css">
    * {
      margin: 0;
      padding: 0;
    }
    body {
      background-color: black;
      color: white;
      line-height: 1.6;
      margin: 1ex;
      font-family: monospace;
    }
    a {
      color: #00ccff;
    }
    .property {
      background-color: #111111;
      border: 1px solid #808080;
      margin: 1ex 0;
      padding: 1ex;
    }
    .name {
      font-size: larger;
      font-weight: bold;
    }
    .type {
      display: table-cell;
      padding-right: 1ex;
      color: #ff9999;
    }
    .value {
      display: table-cell;
      color: #c0c0c0;
    }
    .type.string + .value:before,
    .type.string + .value:after {
      color: #c0c0c0;
      content: '"';
    }
    .value.null,
    .type.string + .value,
    .type.number + .value,
    .type.boolean + .value {
      color: #99ff66;
    }
    </style>
  </head>
  <body>
    <div class="properties" id="root"></div>
    <script type="text/javascript">
(function() {
  var IE = "\v" === "v";
  if (IE) {
    Array.prototype.forEach = Array.prototype.forEach || function(f) {
      for (var i = 0; i < this.length; ++i) f(this[i]);
    };
    Array.prototype.map = Array.prototype.map || function(f) {
      for (var i = 0; i < this.length; ++i) this[i] = f(this[i]);
      return this;
    };
  }
  function memberOp(key) {
    // 3 種類のメンバ演算子記法のうちどれが適切かの判断
    // .$0 [-0.5] ["for"]
    if (!/[^\w$]/.test(key) && !/^\d/.test(key)) {
      try {
        eval("''." + key); // ''.for などの予約語系文法違反検知
        return 0;
      } catch(e) {}
    } else if (String(Number(key)) === key) return 1; // a[0x1]
    return 2;
  };
  function getProps(prop) {
    // prop.value の持つプロパティ群を配列にする
    var obj = prop.value;
    var path = prop.path;
    if (obj === null) return;
    var keys = [];
    for (var key in obj) {
      // try catch は読み取り禁止エラー対策
      try {
        String(obj[key]); // 読み取り禁止ならここでエラー
        keys.push(key);
      } catch(e) {}
    }
    keys = (function(keys) {
      var num = [], al = [];
      keys.forEach(function(key) {
        (memberOp(key) === 1 ? num : al).push(key);
      });
      num.sort(function(a, b) { return a - b; });
      al.sort();
      return num.concat(al);
    })(keys);
    return keys.map(function(key) {
      return {
        "name" : key,
        "type" : typeof prop.value[key],
        "value" : prop.value[key],
        "path" : prop.path +
        ["." + key, "[" + key + "]", '["' + key + '"]'][memberOp(key)]
      };
    });
  };
  function toHTML(prop) {
    // prop を HTML の要素に変換
    var property = document.createElement("div");
    var name = document.createElement("div");
    var type = document.createElement("div");
    var value = document.createElement("div");
    property.className = "property";
    name.className = "name";
    type.className = "type " + prop.type;
    value.className = "value" +
    (prop.value === null ? " null" : "");
    if ((function(obj) {
      // prop.value がプロパティを持っているなら
      if (obj !== null) try {
        for (var index in obj) return true;
      } catch(e) {}
      return false;
    })(prop.value)) {
      // リンクにする
      var a = document.createElement("a");
      a.href = "javascript:;";
      a.prop = prop;
      a.property = property;
      IE ? a.attachEvent("onclick", function(v) {
        v.target = v.srcElement;
        onNameClick(v);
      }, false):
      a.addEventListener("click", onNameClick, false);
      a.appendChild(document.createTextNode(prop.path));
      name.appendChild(a);
    } else {
      name.appendChild(document.createTextNode(prop.path));
    }
    type.appendChild(document.createTextNode(prop.type));
    value.appendChild(document.createTextNode(prop.value));
    property.appendChild(name);
    property.appendChild(type);
    property.appendChild(value);
    return property;
  };
  function onNameClick(v) {
    // リンク選択時の挙動
    var a = v.target;
    if (!a.properties) {
      a.properties = document.createElement("div");
      a.properties.className = "properties";
    } else while (a.properties.hasChildNodes()) {
      a.properties.removeChild(a.properties.lastChild);
    }
    getProps(a.prop).forEach(function(prop) {
      a.properties.appendChild(toHTML(prop));
    });
    var properties = a.property.parentNode;
    while (properties.hasChildNodes()) {
      properties.removeChild(properties.lastChild);
    }
    a.property.appendChild(a.properties);
    properties.appendChild(a.property);
    scrollTo(0, 0);
  };
  document.getElementById("root").appendChild(toHTML(new function() {
    var hash = decodeURI(location.search.slice(1));
    var hashev = (function(hash) {
      try { return eval(hash); } catch (E) { return false; }
    })(hash);
    this.name = hashev ? hash : "window";
    this.value = hashev || window;
    this.type = typeof this.value;
    this.path = this.name;
  }));
  document.links[0] && onNameClick({"target" : document.links[0]});
})();
    </script>
  </body>
</html>
