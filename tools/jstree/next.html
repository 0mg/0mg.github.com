<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8" />
<title>JSObjTree</title>
<style>/*<![CDATA[*/
* {
  margin: 0;
  padding: 0;
  font-family: "MS UI Gothic", monospace;
  line-height: 1.3;
}
body {
  background: #f0f0f0;
  font-size: 12px;
}
.item {
  word-wrap: break-word;
  cursor: pointer;
  background: #fff;
  display: block;
  float: left;
  width: 70px;
  height: 70px;
  margin: 10px;
  padding: 0px;
  text-align: center;
}
.item:hover {
  background: navy;
  color: white;
}
.iicon {
  margin: 2px auto;
  border: 1px solid;
  width: 32px;
  height: 32px;
}
.iname {
  margin: 2px auto;
  font-size: 12px;
}
.iicon.object {
  background: #ffc;
}
.iicon.number {
  background: #fcc;
}
.iicon.function {
  background: #cef;
}
.iicon.string {
  background: #cfc;
}
.iicon.boolean {
  background: #aaf;
}
#cpath {
  width: 90%;
}
#side, #list {
  display: table-cell;
  vertical-align: top;
}
#list {
  background: #ddd;
  overflow: auto;
  position: absolute;
  top: 50px;
  bottom: 0;
  left: 120px;
}
#side {
  width: 120px;
  max-width: 120px;
  border-right: 1px solid;
}
dt {
  font-weight: bold;
}
dd {
  margin-bottom: 1ex;
}
#cname {
  border-bottom: 1px solid;
}
/*]]>*/</style>
</head>
<body>
<div><button id="cup">up</button><input id="cpath" value="window" /><button id="cgo">open</button></div>
<h1 id="cname">window</h1>
<div id="side">
<dl id="profile">
<dt>name</dt>
<dd id="fname">document</dd>
<dt>type</dt>
<dd id="ftype">object</dd>
<dt>value</dt>
<dd id="fvalue">[object HTMLDocument]</dd>
</dl>
</div>
<ul id="list">
<li class="item">
  <div class="iicon object"></div>
  <div class="iname">document</div>
</li>
<li class="item">
  <div class="iicon number"></div>
  <div class="iname">length</div>
</li>
</ul>
<script>//<![CDATA[
if (!window.addEventListener) {
  window.addEventListener = function(type, f) {
    return this.attachEvent("on" + type, f);
  };
}
if (!Element.prototype.addEventListener) {
  Element.prototype.addEventListener = window.addEventListener;
}
if (!Array.prototype.forEach) {
  Array.prototype.forEach = function(f) {
    for (var i = 0; i < this.length; ++i) {
      f(this[i], i, this);
    }
  };
}
if (!Array.prototype.map) {
  Array.prototype.map = function(f) {
    var a = [];
    for (var i = 0; i < this.length; ++i) {
      a[i] = f(this[i], i, this);
    }
    return a;
  };
}
//]]></script>
<script>//<![CDATA[
var $testObj = {
  "num": 123,
  "str": "hoge",
  "func": function() {},
  "bool": true,
  "[\"obj\"][\\\"o\"]": {
    "none": "fuga"
  },
  "und": void 0
};
var dom = {
  id: function(id) { return document.getElementById(id); },
  ce: function(s) { return document.createElement(s); },
  ct: function(s) { return document.createTextNode(s); }
};
var mem = (function() {
  var ram = {};
  return {
    setCurrent: function(prop) {
      ram.path = prop.path;
    },
    getCurrent: function() {
      return {
        path: ram.path
      };
    }
  };
})();
function openDir(prop, h) {
  mem.setCurrent(prop);
  if (h) location.hash = "#" + prop.path;
  setPath(prop.path);
  setCName(prop.name);
  hideProfile();
  setList(getProps(prop));
}
function setList(props) {
  var list = dom.id("list");
  var f = document.createDocumentFragment();
  props.forEach(function(p) {
    f.appendChild(p.toNode());
  });
  clearList();
  list.appendChild(f);
}
function clearList() {
  var list = dom.id("list");
  while (list.hasChildNodes()) {
    list.removeChild(list.lastChild);
  }
}
function setProfile(prop) {
  var fname = dom.id("fname");
  var ftype = dom.id("ftype");
  var fvalue = dom.id("fvalue");
  fname.textContent = prop.name;
  ftype.textContent = prop.type;
  fvalue.textContent = prop.type === "string" ?
                       '"' + String(prop.value) + '"': String(prop.value);
}
function hideProfile() {
  var profile = dom.id("profile");
  profile.style.visibility = "hidden";
}
function showProfile() {
  var profile = dom.id("profile");
  profile.style.visibility = "visible";
}
function setCName(name) {
  var cname = dom.id("cname");
  cname.textContent = name;
}
function setPath(path) {
  var cpath = dom.id("cpath");
  cpath.value = path;
}
/*
{
  name: "document",
  type: "object",
  value: "[object HTMLDocument]",
  path: "window.document"
}
*/
function memberOp(key) {
  // 0: . 1: [0] 2: ["0x1"]
  try { eval("''." + key); return 0; } catch(e) {}
  if (String(Number(key)) === key) return 1;
  return 2;
}
function getDirs(path) {
  var re = /[$_a-zA-Z][$\w]*|\[\s*-?\d+\.?\d*\s*\]|\[\s*("|')(?:\\u[0-9a-fA-F]{4}|\\x[0-9a-fA-F]{2}|\\[^]|[^])*?\1\s*\]/g;
  return path.match(re);
}
function getProp(path) {
  var value;
  try { value = eval(path); } catch (e) { return false; }
  var dirs = getDirs(path);
  var ctx = "";
  if (dirs) {
    ctx = dirs.pop().
      replace(/^\[\s*["']?|["']?\s*\]$/g, "").
      replace(/\\(["'\\])/g, "$1");
  }
  var name = ctx;
  var prop = {
    name: name,
    type: typeof value,
    value: value,
    path: path
  };
  return prop;
}
function Prop(i, prop) {
  if (!(this instanceof Prop)) return;
  this.name = i;
  this.type = typeof prop.value[i];
  this.value = prop.value[i];
  switch (memberOp(i)) {
  case 0:
    this.path = prop.path + "." + i;
    break;
  case 1:
    this.path = prop.path + "[" + i + "]";
    break;
  default:
    this.path = prop.path + '["' + i.replace(/(?=["'\\])/g, "\\") + '"]';
  }
}
Prop.prototype.toNode = function() {
/*
<li class="item">
  <div class="iicon object"></div>
  <div class="iname">document</div>
</li>
*/
  var prop = this;
  var item = dom.ce("li");
  var iicon = dom.ce("div");
  var iname = dom.ce("div");

  item.className = "item";
  item.appendChild(iicon);
  item.appendChild(iname);
  item.addEventListener("mouseover", function() {
    setProfile(prop);
    showProfile();
  }, false);
  item.addEventListener("click", function() {
    openDir(prop, true);
  }, false);

  iicon.className = "iicon " + this.type;

  iname.className = "iname";
  iname.appendChild(dom.ct(this.name));

  return item;
};
Prop.prototype.toString = function() {
  return this.name;
};
function getProps(prop) {
  var props = [];
  for (var i in prop.value) {
    try { String(prop.value[i]); } catch(e) { continue; }
    props.push(new Prop(i, prop));
  }
  var num = [], al = [];
  props.forEach(function(p) {
    (memberOp(p.name) === 1 ? num : al).push(p);
  });
  num.sort(function(p, q) { return p.name - q.name; });
  al.sort(function(p, q) { return p.name.localeCompare(q.name); });
  props = num.concat(al);
  return props;
}
function goPath(path, h) {
  path = path || cpath.value;
  var prop = getProp(path);
  if (prop) openDir(prop, h);
}
function init() {
  var cpath = dom.id("cpath");
  var cup = dom.id("cup");
  var cgo = dom.id("cgo");
  cpath.addEventListener("keypress", function(ev) {
    switch (ev.keyCode) {
    case 27:
      cpath.value = mem.getCurrent().path;
      break;
    case 13:
      goPath(null, true);
      break;
    }
  }, false);
  cup.addEventListener("click", function() {
    var parent_path = getDirs(cpath.value).slice(0, -1).map(function(d, i) {
      return (i === 0 || d[0] === "[") ? d : "." + d;
    }).join("");
    goPath(parent_path, true);
  }, false);
  cgo.addEventListener("click", function() {
    goPath(null, true);
  }, false);
}
addEventListener("hashchange", function(ev) {
  if (mem.getCurrent().path !== location.hash.slice(1)) {
    goPath(location.hash.slice(1) || "window");
  }
}, false);
addEventListener("load", function() {
  init();
  var h = location.hash.slice(1);
  location.hash = "window";
  goPath("window");
  setPath(h || "window");
}, false);
//]]></script>
</body>
</html>
