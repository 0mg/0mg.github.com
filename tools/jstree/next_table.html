<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8" />
<title>JSObjTree</title>
<style>/*<![CDATA[*/
*:not(button) {
  margin: 0;
  padding: 0;
  font-family: monospace;
  line-height: 1.3;
}
body {
  background: #f9f9f9;
  font-size: 15px;
}
table {
  border-collapse: collapse;
}
th, td {
  vertical-align: top;
  padding: 0.5ex;
  border: 1px solid silver;
}
#address {
  width: 100%;
}
#civalue {
  white-space: pre-wrap;
}
.iname {
  color: blue;
  cursor: pointer;
}
.iname:hover {
  color: red;
  text-decoration: underline;
}
.iname:active,
.iname.focus {
  color: white;
  background: navy;
}
.item.object .itype {
  background: #ffa;
}
.item.number .itype {
  background: #fcc;
}
.item.function .itype {
  background: #bff;
}
.item.string .itype {
  background: #9f9;
}
.item.boolean .itype {
  background: #bbf;
}
.item.undefined .itype {
  color: #fff;
  background: #777;
}
.item.null .itype {
  color: #fff;
  background: #000;
}
.item.object .ivalue,
.item.function .ivalue,
.item.undefined .ivalue {
  color: #333;
}
.item.number .ivalue,
.item.string .ivalue,
.item.boolean .ivalue,
.item.null .ivalue {
  font-weight: bold;
}
.item.string .ivalue::before,
.item.string .ivalue::after {
  color: gray;
  font-weight: normal;
  content: '"';
}
/*]]>*/</style>
</head>
<body>
<input id="address" value="window" /><button id="cup">up</button><button id="cgo">go</button>
<h1 id="cname">window</h1>
<table>
<tbody>
<tr id="citem" class="item object">
  <td id="citype" class="itype">obj</td><td><pre id="civalue" class="ivalue">[obJect W_indow]</pre></td>
</tr>
</tbody>
</table>
<table>
<caption id="cpath">window</caption>
<thead><tr><th>type</th><th>key</th><th>value</th></tr></thead>
<tbody id="list">
<tr class="item">
  <td class="itype">number</td><td class="iname">length</td><td class="ivalue">30</td>
</tr>
</tbody>
</table>
<script>//<![CDATA[
if (!window.addEventListener) {
  window.addEventListener = function(type, f) {
    return this.attachEvent("on" + type, f);
  };
}
if (!Element.prototype.addEventListener) {
  Element.prototype.addEventListener = window.addEventListener;
}
if (!Array.prototype.forEach) {
  Array.prototype.forEach = function(f) {
    for (var i = 0; i < this.length; ++i) {
      f(this[i], i, this);
    }
  };
}
if (!Array.prototype.map) {
  Array.prototype.map = function(f) {
    var a = [];
    for (var i = 0; i < this.length; ++i) {
      a[i] = f(this[i], i, this);
    }
    return a;
  };
}
//]]></script>
<script>//<![CDATA[
var $testObj = {
  "\0\b\f\n\r\t\v\'\"\\": 123,
  "str\ning": '"\\hoge',
  "func\0tion": function() {},
  "bool": true,
  "[\"obj\"][\\\"o\"]": {
    "#": "fuga"
  },
  "und": void 0,
  "nil": null
};
function encode(s) {
  return encodeURIComponent(s);
}
var dom = {
  id: function(id) { return document.getElementById(id); },
  q: function(s) { return document.querySelector(s); },
  qs: function(s) { return document.querySelectorAll(s); },
  ce: function(s) { return document.createElement(s); },
  ct: function(s) { return document.createTextNode(s); }
};
var mem = (function() {
  var ram = {};
  return {
    setCurrent: function(prop) {
      ram.prop = prop;
    },
    getCurrent: function() {
      return {
        name: ram.prop.name,
        type: ram.prop.type,
        value: ram.prop.value,
        path: ram.prop.path
      };
    }
  };
})();
function getHash(h) {
  if (!h) h = location.hash;
  try {
    return decodeURIComponent(h.slice(1));
  } catch(e) {
    return h.slice(1);
  }
}
function setHash(s) {
  location.hash = encodeURIComponent(s);
}
function openDir(prop, h) {
  mem.setCurrent(prop);
  if (h) setHash(prop.path);
  setAddress(prop.path);
  setPath(prop.path);
  setCList(prop);
  setList(getProps(prop));
  focusItem();
}
function setList(props) {
  var list = dom.id("list");
  var f = document.createDocumentFragment();
  var i = 0, lim = props.length < 1000 ? props.length : 1000;
  for (; i < lim; ++i) {
    f.appendChild(props[i].toNode())
  }
  clearList();
  list.appendChild(f);
}
function clearList() {
  var list = dom.id("list");
  while (list.hasChildNodes()) {
    list.removeChild(list.lastChild);
  }
}
function setCList(prop) {
  var cname = dom.id("cname");
  cname.lastChild.nodeValue = escapeKey(prop.name);

  var citem = dom.id("citem");
  citem.className = "item " + prop.type;

  var citype = dom.id("citype");
  citype.lastChild.nodeValue = prop.type;

  var civalue = dom.id("civalue");
  civalue.lastChild.nodeValue = String(prop.value);
}
function setAddress(path) {
  var address = dom.id("address");
  address.value = path;
}
function setPath(path) {
  var cpath = dom.id("cpath");
  cpath.lastChild.nodeValue = path;
}
/*
{
  name: "document",
  type: "object",
  value: "[object HTMLDocument]",
  path: "window.document"
}
*/
function memberOp(key) {
  // 0: . 1: [0] 2: ["0x1"]
  try { eval("''." + key); return 0; } catch(e) {}
  if (String(Number(key)) === key) return 1;
  return 2;
}
function getDirs(path) {
  var re = /[$_a-zA-Z][$\w]*|\[\s*-?\d+\.?\d*\s*\]|\[\s*("|')(?:\\u[0-9a-fA-F]{4}|\\x[0-9a-fA-F]{2}|\\[^]|[^])*?\1\s*\]/g;
  return path.match(re);
}
function getProp(path) {
  var value;
  try { value = eval(path); } catch (e) { return false; }
  var dirs = getDirs(path);
  var ctx = "";
  if (dirs) {
    ctx = unescapeKey(dirs.pop().replace(/^\[\s*["']?|["']?\s*\]$/g, ""));
  }
  var name = ctx;
  var prop = {
    name: name,
    type: value === null ? "null" : typeof value,
    value: value,
    path: path
  };
  return prop;
}
function unescapeKey(key) {
  return key.replace(/\\[^]/g, function(c) {
    var chr = {
      "\\0": "\0",
      "\\b": "\b",
      "\\f": "\f",
      "\\n": "\n",
      "\\r": "\r",
      "\\t": "\t",
      "\\v": "\v",
      "\\\"": "\"",
      "\\\'": "\'",
      "\\\\": "\\"
    };
    return chr[c] || c;
  });
}
function escapeKey(key) {
  return key.replace(/[^]/g, function(c) {
    var chr = {
      "\0": "\\0",
      "\b": "\\b",
      "\f": "\\f",
      "\n": "\\n",
      "\r": "\\r",
      "\t": "\\t",
      "\v": "\\v",
      "\"": "\\\"",
      "\'": "\\\'",
      "\\": "\\\\"
    };
    return chr[c] || c;
  });
}
function Prop(i, prop) {
  if (!(this instanceof Prop)) return;
  this.name = i;
  this.type = prop.value[i] === null ? "null" : typeof prop.value[i];
  this.value = prop.value[i];
  switch (memberOp(i)) {
  case 0:
    this.path = prop.path + "." + i;
    break;
  case 1:
    this.path = prop.path + "[" + i + "]";
    break;
  default:
    this.path = prop.path + '["' + escapeKey(i) + '"]';
  }
}
Prop.prototype.toNode = function() {
/*
<tr class="item">
  <td class="itype">number</td><td class="iname">length</td><td class="ivalue">30</td>
*/
  var prop = this;
  var item = dom.ce("tr");
  var itype = dom.ce("td");
  var iname = dom.ce("td");
  var ivalue = dom.ce("td");

  item.className = "item " + this.type;
  item.appendChild(itype);
  item.appendChild(iname);
  item.appendChild(ivalue);

  itype.className = "itype"
  itype.appendChild(dom.ct(this.type));

  iname.className = "iname";
  iname.appendChild(dom.ct(escapeKey(this.name)));
  iname.addEventListener("click", function() {
    openDir(prop, true);
  }, false);

  ivalue.className = "ivalue";
  var value = String(this.value).replace(/([^]{140})[^]*/, "$1...");
  ivalue.appendChild(dom.ct(value));

  return item;
};
Prop.prototype.toString = function() {
  return this.name;
};
function getKeys(prop) {
  var props = [];
  var kees = {};
  if (prop.type === "object" || prop.type === "function") {
    var keys = Object.getOwnPropertyNames(prop.value);
    for (var i = 0; i < keys.length; ++i) {
      var key = keys[i];
      try { String(prop.value[key]); } catch(e) { continue; }
      if (kees[key] !== true) props.push(new Prop(key, prop));
      kees[key] = true;
    }
  }
  if (prop.type !== "string") {
    for (var key in prop.value) {
      try { String(prop.value[key]); } catch(e) { continue; }
      if (kees[key] !== true) props.push(new Prop(key, prop));
      kees[key] = true;
    }
  }
  switch (prop.type) {
  case "function":
    try {
      String(prop.value["prototype"]);
      if (kees["prototype"] !== true) props.push(new Prop("prototype", prop));
      kees["prototype"] = true;
    } catch(e) {}
  case "object":
  case "number":
  case "boolean":
  case "string":
    try {
      String(prop.value["__proto__"]);
      if (kees["__proto__"] !== true) props.push(new Prop("__proto__", prop));
      kees["__proto__"] = true;
    } catch(e) {}
    break;
  }
  return props;
}
function getProps(prop) {
  var props = [];
  props = getKeys(prop);
  var num = [], al = [];
  props.forEach(function(p) {
    (memberOp(p.name) === 1 ? num : al).push(p);
  });
  num.sort(function(p, q) { return p.name - q.name; });
  al.sort(/*function(p, q) { return p.name.toLowerCase().localeCompare(q.name.toLowerCase()); }*/);
  props = num.concat(al);
  return props;
}
function goPath(path, h) {
  var prop = getProp(path);
  if (prop) openDir(prop, h);
}
function focusItem(key) {
  if (key) {
    var keys_e = dom.qs(".iname");
    for (var i = 0; i < keys_e.length; ++i) {
      var e = keys_e[i];
      if (e.textContent === key) {
        e.classList.add("focus");
        e.scrollIntoView();
        break;
      }
    }
  } else {
    document.documentElement.scrollIntoView();
  }
}
function init() {
  var address = dom.id("address");
  var cup = dom.id("cup");
  var cgo = dom.id("cgo");
  address.addEventListener("keypress", function(ev) {
    switch (ev.keyCode) {
    case 27:
      address.value = mem.getCurrent().path;
      break;
    case 13:
      if (address.value !== mem.getCurrent().path) goPath(address.value, true);
      break;
    }
  }, false);
  cup.addEventListener("click", function() {
    var cur_path = mem.getCurrent().path;
    var parent_path = getDirs(cur_path).slice(0, -1).map(function(d, i) {
      return (i === 0 || d[0] === "[") ? d : "." + d;
    }).join("") || "window";
    if (cur_path !== parent_path) goPath(parent_path, true);
  }, false);
  cgo.addEventListener("click", function() {
    if (address.value !== mem.getCurrent().path) goPath(address.value, true);
  }, false);
  window.addEventListener("mousedown", function() {
    var s = dom.q(".focus");
    if (s) s.classList.remove("focus");
  }, true);
}
addEventListener("hashchange", function(ev) {
  var h = getHash();
  if (h !== mem.getCurrent().path) {
    goPath(h);
    var oldKey = getDirs(getHash(ev.oldURL)).pop().
      replace(/^\[\s*["']?|["']?\s*\]$/g, "");
    focusItem(oldKey);
  }
}, false);
addEventListener("load", function() {
  init();
  var h = getHash();
  setHash("window");
  goPath("window");
  setAddress(h || "window");
  setPath("window");
}, false);
//]]></script>
</body>
</html>
